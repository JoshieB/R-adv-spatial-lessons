# Tidy Spatial Analysis {#tidy}

Resources:

- [Tidy spatial data in R: using dplyr, tidyr, and ggplot2 with sf](http://strimas.com/r/tidy-sf/)

## Overview {.objectives}

**Questions**
- How to elegantly conduct complex spatial analysis?

**Objectives**
- Use the `%>%` operator (aka "then" or "pipe") to pass output from one function into input of the next.
- Calculate metrics on spatial attributes.
- Aggregate spatial data with metrics.

## Things You'll Need to Complete this Tutorial {.prereq}

**R Skill Level**: Intermediate - you've got basics of R down.

You'll need ...

We will use the `sf` package for vector data along with the `dplyr` package for calculating and manipulating attribute data.

```{r , message=F, warning=F}
# load packages
library(tidyverse)  # dplyr, tidyr, ggplot2
library(sf)         # vector reading & analysis

# set working directory to data folder
# setwd("pathToDirHere")
```

## US States: Read and Plot

Similar to [Lesson 9: Handling Spatial Projection & CRS in R](https://jsta.github.io/R-spatial-raster-vector-lesson/09-vector-when-data-dont-line-up-crs/), we'll start by reading in a polygon shapefile using the `sf` package. Then use the default `plot()` function to see what it looks like.

```{r}
# read in states
states <- read_sf("data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp")
plot(states)
```

You'll notice that the default plot on `sf` objects outputs colorized values of the first 9 of 10 columns. Use the suggestion from the warning to plot the 10th column.

```{r}
# plot 10th column
plot(states, max.plot = 10)

# show columns of the data frame
names(states)

# look at table
glimpse(states)

# convert to tibble for nicer printing
as_tibble(states)

names(states)

# inspect the class(es) of the states object
class(states)
```

The class of the `states` object is both a simple feature (`sf`) as well as a data frame, which means the many useful functions available to a data frame (or "tibble") can be applied.

To plot the column of interest, feed the "slice" of that column to the `plot()` function.

```{r}
plot(states['region'])
```

**Question**: To motivate the spatial analysis for the rest of this lesson, let's answer this question: "_**Show which regions have the highest ratio of water to land?**_"

## Challenge: What analytical steps are required to answer the question? {.challenge}

Outline a sequence of analytical steps needed to arrive at the answer.

### Answers {.solution} 

1. **Sum** the area of water and land per region.
1. **Divide** the area of water by the area of land per region to arrive at density of water.
1. Show **table** of regions sorted by density of water.
1. Show **map** of regions by density of water with a color ramp and legend.

## US States: Analyze Attributes

```{r}
regions = states %>%
  group_by(region) %>%
  summarize(
    water = sum(AWATER),
    land  = sum(ALAND)) %>%
  mutate(
    water_land = water / land)

# object
regions

# table
regions %>%
  st_set_geometry(NULL) %>%
  arrange(desc(water_land))

# plot, default
plot(regions['water_land'])

# plot, ggplot
ggplot(regions) +
  geom_sf(aes(fill = water_land)) +
  scale_fill_distiller("water_land", palette = "Spectral") +
  theme_bw() +
  ggtitle("Ratio of Water to Land for US Regions")
```

## US States: Recalculate Area

Because in geographic coordinates, need to either transform to projection and calculate area, or use geodesic calculations.

```{r}
library(geosphere)
library(units)

regions = states %>%
  mutate(
    water_m2 = AWATER %>% set_units(m^2),
    land_m2  = geometry %>% st_zm() %>% st_area()) %>%
  group_by(region) %>%
  summarize(
    water_m2 = sum(water_m2),
    land_m2  = sum(land_m2)) %>%
  mutate(
    water_land = water_m2 / land_m2)

# table
regions %>%
  st_set_geometry(NULL) %>%
  arrange(desc(water_land))

# plot, ggplot
ggplot(regions) +
  geom_sf(aes(fill = as.numeric(water_land))) +
  scale_fill_distiller("water_land", palette = "Spectral") +
  theme_bw() +
  ggtitle("Ratio of Water to Land (geodesic) for US Regions ")
```

## Pipe Operator

- Help > Keyboard Shortcuts Help. 


## Challenge: Project States and Calculate Area {.challenge}

Use `st_transform()` [USA Contiguous Albers Equal Area Conic: ESRI Projection -- Spatial Reference](http://spatialreference.org/ref/esri/usa-contiguous-albers-equal-area-conic/).

### Answers {.solution} 

- ESRI:102003

```{r}
library(geosphere)
library(units)

# Proj4 of http://spatialreference.org/ref/esri/usa-contiguous-albers-equal-area-conic/
crs_usa = '+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs'

regions = states %>%
  st_transform(crs_usa) %>%
  mutate(
    water_m2 = AWATER %>% set_units(m^2),
    land_m2  = geometry %>% st_zm() %>% st_area()) %>%
  group_by(region) %>%
  summarize(
    water_m2 = sum(water_m2),
    land_m2  = sum(land_m2)) %>%
  mutate(
    water_land = water_m2 / land_m2)

# table
regions %>%
  st_set_geometry(NULL) %>%
  arrange(desc(water_land))

# plot, ggplot
ggplot(regions) +
  geom_sf(aes(fill = as.numeric(water_land))) +
  scale_fill_distiller("water_land", palette = "Spectral") +
  theme_bw() +
  ggtitle("Ratio of Water to Land (geodesic) for US Regions ")
```

## Key Points {.keypoints}
- Area can be calculated a variety of ways. Geodesic is preferred if starting with geographic coordinates (vs projected).



## Issues

```{r}

```

- `sf::st_is_valid()`

